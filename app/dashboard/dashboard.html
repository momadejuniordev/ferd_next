<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Completa - Projetos</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <style>
        body.dark-scheme { background-color: #121212; color: #fff; }
        .sidebar { width: 220px; position: fixed; top:0; left:0; height: 100%; background:#1c1c1c; padding-top:20px; }
        .sidebar a { display:block; color:#fff; padding:10px 20px; text-decoration:none; }
        .sidebar a:hover { background:#0d6efd; color:#fff; }
        .content { margin-left:230px; padding:20px; }
        table { width:100%; border-collapse: collapse; }
        th, td { padding:10px; border-bottom:1px solid #444; text-align:left; }
        th { background:#222; }
        .btn { margin-right:5px; }
        .loader { display:none; border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #0d6efd; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-left:10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .preview-img { max-width: 100px; margin-top: 10px; margin-right: 10px; border-radius: 5px; display: inline-block; }
        .form-section { display:none; margin-top:30px; }
        .alert { display:none; margin-top:10px; }
    </style>
</head>
<body class="dark-scheme">

    <div class="sidebar">
        <a href="#" id="nav-dashboard">Dashboard</a>
        <a href="#" id="nav-publish">Publicar Projeto</a>
        <a href="#" id="nav-my-projects">Meus Projetos</a>
        <a href="#">Configurações</a>
        <a href="#">Sair</a>
    </div>

    <div class="content">
        <h2>Resumo Rápido</h2>
        <div id="summary">
            <p>Total de projetos: <span id="total-projects">0</span></p>
        </div>

        <div id="projects-section">
            <h2>Meus Projetos</h2>
            <table id="projects-table">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Categoria</th>
                        <th>Ano</th>
                        <th>Cliente</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Formulário de publicação -->
        <div id="publish-form" class="form-section">
            <h3 id="form-title">Publicar Projeto</h3>
            <div class="alert alert-success" id="success-alert">Projeto publicado com sucesso!</div>
            <div class="alert alert-danger" id="error-alert">Erro ao publicar projeto!</div>
            <form id="project-form">
                <div class="mb-3">
                    <label for="title">Título</label>
                    <input type="text" class="form-control" id="title" required>
                </div>
                <div class="mb-3">
                    <label for="overview">Resumo</label>
                    <textarea class="form-control" id="overview" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="objectives">Objetivos (separados por vírgula)</label>
                    <input type="text" class="form-control" id="objectives">
                </div>
                <div class="mb-3">
                    <label for="category">Categoria</label>
                    <select class="form-select" id="category" required>
                        <option value="">Selecionar categoria</option>
                        <option value="Identidade Visual">Identidade Visual</option>
                        <option value="Branding">Branding</option>
                        <option value="Marketing Digital">Marketing Digital</option>
                        <option value="Web Design">Web Design</option>
                        <option value="Fotografia">Fotografia</option>
                        <option value="Vídeo">Vídeo</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="year">Ano</label>
                    <input type="number" class="form-control" id="year" required>
                </div>
                <div class="mb-3">
                    <label for="client">Cliente</label>
                    <input type="text" class="form-control" id="client">
                </div>
                <div class="mb-3">
                    <label for="awards">Prêmios (opcional)</label>
                    <input type="text" class="form-control" id="awards">
                </div>
                <div class="mb-3">
                    <label for="images">Imagens</label>
                    <input type="file" class="form-control" id="images" multiple accept="image/*">
                    <div id="preview-container"></div>
                </div>
                <div class="mb-3">
                    <label for="client-says-text">Depoimento do Cliente (opcional)</label>
                    <textarea class="form-control" id="client-says-text" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="client-says-name">Nome do Cliente</label>
                    <input type="text" class="form-control" id="client-says-name">
                </div>
                <button type="submit" class="btn btn-primary" id="submit-btn">Publicar Projeto</button>
                <div class="loader" id="form-loader"></div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const USER_ID = "eb522b20-b2f2-44ff-adfa-c79db669b92a";

        const navPublish = document.getElementById('nav-publish');
        const navMyProjects = document.getElementById('nav-my-projects');
        const publishFormDiv = document.getElementById('publish-form');
        const projectsSection = document.getElementById('projects-section');
        const projectsTableBody = document.querySelector('#projects-table tbody');
        const totalProjectsSpan = document.getElementById('total-projects');
        const projectForm = document.getElementById('project-form');
        const imagesInput = document.getElementById('images');
        const previewContainer = document.getElementById('preview-container');
        const loader = document.getElementById('form-loader');
        const submitBtn = document.getElementById('submit-btn');

        let editingProjectId = null;

        // Toggle views
        navPublish.addEventListener('click', () => {
            projectsSection.style.display = 'none';
            publishFormDiv.style.display = 'block';
            projectForm.reset();
            previewContainer.innerHTML = '';
            submitBtn.textContent = 'Publicar Projeto';
            editingProjectId = null;
        });

        navMyProjects.addEventListener('click', async () => {
            publishFormDiv.style.display = 'none';
            projectsSection.style.display = 'block';
            await loadProjects();
        });

        // Preview das imagens
        imagesInput.addEventListener('change', () => {
            previewContainer.innerHTML = '';
            Array.from(imagesInput.files).forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview-img';
                previewContainer.appendChild(img);
            });
        });

        // Carregar projetos
        async function loadProjects() {
            const { data, error } = await supabase.from('projects')
                .select('*')
                .eq('user_id', USER_ID)
                .order('id', { ascending: false });
            if (error) return console.error(error);

            projectsTableBody.innerHTML = '';
            totalProjectsSpan.textContent = data.length;

            data.forEach(project => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${project.title}</td>
                    <td>${project.category || ''}</td>
                    <td>${project.year || ''}</td>
                    <td>${project.client || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-edit" data-id="${project.id}">Editar</button>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="${project.id}">Excluir</button>
                    </td>
                `;
                projectsTableBody.appendChild(tr);
            });
        }

        // Editar e Excluir
        projectsTableBody.addEventListener('click', async (e) => {
            const target = e.target;
            const projectId = target.dataset.id;

            if (target.classList.contains('btn-edit')) {
                const { data, error } = await supabase.from('projects')
                    .select('*').eq('id', projectId).single();
                if (error) return console.error(error);

                // Preencher formulário
                document.getElementById('title').value = data.title;
                document.getElementById('overview').value = data.overview || '';
                document.getElementById('objectives').value = (data.objectives || []).join(', ');
                document.getElementById('category').value = data.category || '';
                document.getElementById('year').value = data.year || '';
                document.getElementById('client').value = data.client || '';
                document.getElementById('awards').value = data.awards || '';
                document.getElementById('client-says-name').value = data.client_says_name || '';
                document.getElementById('client-says-text').value = data.client_says_text || '';

                previewContainer.innerHTML = '';
                if (data.images) {
                    data.images.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'preview-img';
                        previewContainer.appendChild(img);
                    });
                }

                projectsSection.style.display = 'none';
                publishFormDiv.style.display = 'block';
                submitBtn.textContent = 'Atualizar Projeto';
                editingProjectId = projectId;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            if (target.classList.contains('btn-delete')) {
                if (!confirm('Deseja realmente excluir este projeto?')) return;
                const { error } = await supabase.from('projects').delete().eq('id', projectId);
                if (error) return console.error(error);
                await loadProjects();
            }
        });

        // Publicar ou atualizar
        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.style.display = 'inline-block';

            const projectData = {
                user_id: USER_ID,
                title: document.getElementById('title').value,
                overview: document.getElementById('overview').value,
                objectives: document.getElementById('objectives').value.split(',').map(s => s.trim()),
                category: document.getElementById('category').value,
                year: document.getElementById('year').value,
                client: document.getElementById('client').value,
                awards: document.getElementById('awards').value,
                client_says_name: document.getElementById('client-says-name').value,
                client_says_text: document.getElementById('client-says-text').value,
                images: [],
                image_url: ''
            };

            try {
                const files = Array.from(imagesInput.files);
                for (let file of files) {
                    const fileName = `${USER_ID}/${Date.now()}_${file.name}`;
                    const { error } = await supabase.storage.from('projects-images').upload(fileName, file);
                    if (error) throw error;
                    const { data: publicData } = supabase.storage.from('projects-images').getPublicUrl(fileName);
                    projectData.images.push(publicData.publicUrl);
                }

                projectData.image_url = projectData.images[0] || '';

                if (editingProjectId) {
                    const { error } = await supabase.from('projects').update(projectData).eq('id', editingProjectId);
                    if (error) throw error;
                } else {
                    const { error } = await supabase.from('projects').insert([projectData]);
                    if (error) throw error;
                }

                projectForm.reset();
                previewContainer.innerHTML = '';
                editingProjectId = null;
                submitBtn.textContent = 'Publicar Projeto';
                publishFormDiv.style.display = 'none';
                projectsSection.style.display = 'block';
                await loadProjects();
            } catch (err) {
                console.error(err);
            } finally {
                loader.style.display = 'none';
            }
        });

        // Inicializa tabela
        loadProjects();
    </script>
</body>
</html>
